# Deployment Environments Schema
# Describes environments (local/staging/prod), connectivity, and deployment methods.

schema:
  environments:
    type: array
    required: true
    description: "List of deployment environments for this project"
    items:
      type: object
      properties:
        name:
          type: enum
          required: true
          options:
            - local
            - dev
            - test
            - staging
            - production
            - sandbox
            - preview
          description: "Environment name"

        purpose:
          type: string
          required: false
          description: "What this environment is used for"
          example: "Pre-production validation and QA"

        is_deployable:
          type: boolean
          required: true
          description: "Whether deployments are expected/allowed here"
          example: true
          detect_from:
            - "If name in {staging, production} -> true (default assumption)"

        base_urls:
          type: array
          required: false
          items:
            type: string
          description: "Base URLs for this environment"
          example: ["https://staging.example.com"]

        # ─────────────────────────────── Network access ─────────────────────────
        network:
          type: object
          required: false
          properties:
            public_access:
              type: boolean
              required: false
              description: "Whether endpoints are reachable from the public internet"

            ip_allowlist_required:
              type: boolean
              required: false
              description: "Whether source IP allowlisting is required to access the environment"
              example: true

            allowlisted_source_ips:
              type: array
              required: false
              items:
                type: string
              description: "Source IPs/CIDRs that are allowed (if allowlisting is used)"
              example: ["203.0.113.10/32", "198.51.100.0/24"]

            target_ips:
              type: array
              required: false
              items:
                type: string
              description: "Target IPs of servers/load balancers/bastions for this environment"
              example: ["10.0.10.12", "10.0.10.13"]

            target_hostnames:
              type: array
              required: false
              items:
                type: string
              description: "Hostnames (preferred over raw IPs if available)"
              example: ["staging-api.internal", "staging-bastion.company.tld"]

            vpn_required:
              type: boolean
              required: false
              description: "Whether VPN is required to access environment resources"

            private_network_note:
              type: string
              required: false
              description: "Notes about VPC/VNet/subnets/peering (optional)"
              example: "VPC peering required from CI runners"

        # ────────────────────────────── SSH / Remote access ──────────────────────
        ssh_access:
          type: object
          required: false
          description: "SSH access details (if applicable)"
          properties:
            supported:
              type: boolean
              required: true
              description: "Whether SSH access exists for this environment"
              example: true

            entrypoint:
              type: enum
              required: false
              options:
                - direct
                - bastion
                - ssh_tunnel
              description: "How SSH access is performed"

            bastion_host:
              type: string
              required: false
              description: "Bastion hostname or IP (if entrypoint=bastion)"
              example: "bastion.company.tld"

            ssh_user:
              type: string
              required: false
              description: "Default SSH username"
              example: "ubuntu"

            ssh_port:
              type: number
              required: false
              description: "SSH port"
              example: 22

            auth_method:
              type: enum
              required: false
              options:
                - ssh_key
                - ssh_certificate
                - password
                - sso
              description: "SSH authentication method"

            key_reference:
              type: string
              required: false
              description: "Reference to where the SSH key/cert is stored (do not put the secret here)"
              example: "vault: secret/ssh/staging-deploy-key"

            has_sudo:
              type: boolean
              required: false
              description: "Whether SSH user can sudo"
              example: false

        # ───────────────────────────── Deployment planning ──────────────────────
        deployment:
          type: object
          required: true
          description: "How deployments to this environment are performed"
          properties:
            allowed_methods:
              type: array
              required: true
              items:
                type: enum
                options:
                  - local_manual
                  - local_scripted
                  - ci_cd
                  - gitops
                  - clickops
                  - third_party_platform
              description: "Deployment methods allowed for this environment"
              example: ["ci_cd", "gitops"]

            primary_method:
              type: enum
              required: true
              options_from: deployment.allowed_methods
              description: "Primary/most common deployment method"

            deploy_from:
              type: array
              required: false
              description: "Where deployments can originate"
              items:
                type: enum
                options:
                  - developer_laptop
                  - ci_runner
                  - bastion_host
                  - admin_vm
                  - platform_control_plane
              example: ["ci_runner"]

            ci_system:
              type: string
              required: false
              description: "CI/CD system used if method includes ci_cd"
              example: "GitHub Actions"

            pipeline_ref:
              type: string
              required: false
              description: "Reference to pipeline/workflow name/path"
              example: ".github/workflows/deploy.yml"

            gitops_tool:
              type: enum
              required: false
              options: ["Argo CD", "Flux", "None"]
              description: "GitOps tool if method includes gitops"

            deploy_strategy:
              type: enum
              required: false
              options:
                - rolling
                - blue_green
                - canary
                - recreate
                - manual
              description: "Deployment strategy"
              example: "rolling"

            requires_approval:
              type: boolean
              required: false
              description: "Whether human approval is required before deploy"
              example: true

            approval_roles:
              type: array
              required: false
              items:
                type: string
              description: "Who can approve deploys"
              example: ["Tech Lead", "On-call"]

            artifacts_source:
              type: enum
              required: false
              options:
